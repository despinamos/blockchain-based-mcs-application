<!DOCTYPE html>
<html>

<head>
	<title> Frontend </title>

	<!-- import Web3.js and Ethers.js -->
	<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
	<script src="./demo.js"></script>
 
</head>

<body>
	<h1>
		HomePage
	</h1>

	<!-- placeholders -->
	<div id="provider"></div>
	<div id="connectedAccount"></div>
	<div id="warn" style="color: red"></div>

	<div>
		<button id="requestAccounts" onclick="Hello()">Connect to Metamask</button>
	</div>

	<form id="dataForm">
		<label for="username">Enter Full Name to Register:</label>
		<input type="text" id="username">
		<button type="submit">Submit form</button>
	</form>

	<script>
		
		if (window.ethereum) {
			// use the injected Ethereum provider to initialize Web3.js
			const web3 = new Web3(window.ethereum);
			try {
				if (typeof window.ethereum !== 'undefined') {
					console.log('MetaMask is installed!');
				}
			} catch (error) {
				console.error('Baka!' + error);
			}
			

			// check if Ethereum provider comes from MetaMask
			if (window.ethereum.isMetaMask) {
				document.getElementById('provider').innerText =
					'Connected to Ethereum with MetaMask.';
			} else {
				document.getElementById('provider').innerText =
					'Non-MetaMask Ethereum provider detected.';
			}

			// click event for "Request MetaMask Accounts" button
			document.getElementById('requestAccounts').addEventListener('click', async () => {
				// request accounts from MetaMask
				await window.ethereum.request({ method: 'eth_requestAccounts' });
				document.getElementById('requestAccounts').remove();

				// get list of accounts
				const accounts = await web3.eth.getAccounts();
				// get the first account and populate placeholder
				document.getElementById(
					'connectedAccount',
				).innerText = `Account: ${accounts[0]}`;
			});

		} else {
			// no Ethereum provider - instruct user to install MetaMask
			document.getElementById('warn').innerHTML =
				"Please <a href='https://metamask.io/download/'>install MetaMask</a>.";
			document.getElementById('requestAccounts').disabled = true;
		}

	</script>

	<button onclick="getLocation()">Give Location (city)</button>


	<script>
	// import "./bundle.js"
		// const {userContract} = require("contractObjectsWeb3.cjs")

    var cityNameGlobal = " "

		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(printLocation);
			} else {
				console.log("Geolocation is not supported by this browser.");
			}
		}

		async function decode_latlong(lat, long) {
			// Replace YOUR_API_KEY with the api key you got from Geoapify
			const apiUrl = `https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${long}&apiKey=${"4e8a03f4dcc24306a83086b605c64112"}`;

			fetch(apiUrl)
				.then(response => response.json())
				.then(data => {
					// Extract the city name from the response
					const cityName = data.features[0].properties.city;
					console.log(`The city is: ${cityName}`);
          cityNameGlobal = cityName;
				})
				.catch(error => {
					console.error('Error:', error);
				});
		}

		function printLocation(position) {
			// console.log("Latitude: " + position.coords.latitude +
			// 	"\nLongitude: " + position.coords.longitude);

			// get city information using the Geoapify key
			const cityName = decode_latlong(position.coords.latitude, position.coords.longitude)
		}

		</script>
		<script>

		// Form Submission
		try {
				document.getElementById("dataForm").addEventListener("submit", async (event) => {
					event.preventDefault();
					console.log("Form submitted");
				});
			} catch (error) {
				console.error('Lets talk about it: ' + error);
			}

			console.log("City name after submit: ", cityNameGlobal)
		
			const name = document.getElementById("username").value;

			console.log("username: ", name)
			
			const userContract = new web3.eth.Contract(userAbi, userContractAddress);
			userContract.handleRevert = true;
		
			if (!name) {
			alert("Please fill in all fields");
			// return;
			}

			// try {
		
			// Interact with the user contract
					//Register user
			// 		const receipt = await userContract.methods.setUser_Information(name).send({
			// 			from: defaultAccount,
			// 			gas: 1000000,
			// 			gasPrice: '10000000000',
			// 		});
			// 		console.log('Transaction Hash: ' + receipt.transactionHash);

			// 		// Get user info
			// 		const userInfo = await userContract.methods.getUserInformation(0).call();
			// 		console.log('User information: ' + userInfo);
		
			// alert("Data successfully stored on the blockchain!");
			// } catch (error) {
			// 			console.error(error);
			// }
				
	</script>

<script src="./bundle.js" defer></script>

</body>

</html>